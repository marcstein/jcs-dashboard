{% extends "base.html" %}

{% block title %}Document Generation - LawMetrics.ai{% endblock %}

{% block head %}
<style>
    .doc-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .doc-header {
        margin-bottom: 30px;
    }

    .doc-header h1 {
        font-size: 1.75rem;
        color: #1a1a2e;
        margin-bottom: 8px;
    }

    .doc-header p {
        color: #666;
        font-size: 0.95rem;
    }

    .doc-chat-container {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 24px;
        min-height: 600px;
    }

    .doc-chat-main {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .doc-messages {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        background: #fafafa;
    }

    .doc-message {
        margin-bottom: 16px;
        display: flex;
        gap: 12px;
    }

    .doc-message.user {
        flex-direction: row-reverse;
    }

    .doc-message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
    }

    .doc-message.assistant .doc-message-avatar {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
    }

    .doc-message.user .doc-message-avatar {
        background: #e5e7eb;
        color: #374151;
    }

    .doc-message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .doc-message.assistant .doc-message-content {
        background: white;
        border: 1px solid #e5e7eb;
    }

    .doc-message.user .doc-message-content {
        background: #6366f1;
        color: white;
    }

    .doc-input-container {
        padding: 16px 24px;
        border-top: 1px solid #e5e7eb;
        background: white;
    }

    .doc-input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }

    .doc-input-wrapper textarea {
        flex: 1;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        font-size: 0.95rem;
        resize: none;
        min-height: 48px;
        max-height: 120px;
        font-family: inherit;
    }

    .doc-input-wrapper textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .btn-send {
        background: #6366f1;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .btn-send:hover {
        background: #4f46e5;
    }

    .btn-send:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }

    .doc-sidebar {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .doc-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        padding: 20px;
    }

    .doc-sidebar {
        max-height: 600px;
        overflow-y: auto;
    }

    .doc-panel h3 {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6b7280;
        margin-bottom: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        user-select: none;
    }

    .doc-panel h3::after {
        content: '\25B2';
        font-size: 0.6rem;
        transition: transform 0.2s;
    }

    .doc-panel h3.collapsed::after {
        transform: rotate(180deg);
    }

    .doc-panel .example-prompts.collapsed,
    .doc-panel .recent-docs.collapsed {
        display: none;
    }

    .example-prompts {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .example-prompt {
        background: #f3f4f6;
        border: none;
        border-radius: 8px;
        padding: 10px 12px;
        text-align: left;
        cursor: pointer;
        font-size: 0.85rem;
        color: #374151;
        transition: background 0.2s;
    }

    .example-prompt:hover {
        background: #e5e7eb;
    }

    .recent-docs {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .recent-doc {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .recent-doc:hover {
        background: #f3f4f6;
    }

    .recent-doc-icon {
        width: 32px;
        height: 32px;
        background: #dbeafe;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #3b82f6;
    }

    .recent-doc-info {
        flex: 1;
        overflow: hidden;
    }

    .recent-doc-name {
        font-size: 0.85rem;
        font-weight: 500;
        color: #1f2937;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .recent-doc-date {
        font-size: 0.75rem;
        color: #9ca3af;
    }

    .doc-welcome {
        text-align: center;
        padding: 60px 40px;
        color: #6b7280;
    }

    .doc-welcome-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 16px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .doc-welcome-icon svg {
        width: 32px;
        height: 32px;
        stroke: white;
    }

    .doc-welcome h2 {
        color: #1f2937;
        font-size: 1.25rem;
        margin-bottom: 8px;
    }

    .doc-welcome p {
        font-size: 0.95rem;
        max-width: 400px;
        margin: 0 auto;
    }

    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 8px 0;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-4px); }
    }

    .doc-download-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #10b981;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        margin-top: 12px;
    }

    .doc-download-btn:hover {
        background: #059669;
    }

    @media (max-width: 900px) {
        .doc-chat-container {
            grid-template-columns: 1fr;
        }

        .doc-sidebar {
            order: -1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="doc-container">
    <div class="doc-header">
        <h1>Document Generation</h1>
        <p>Generate legal documents using natural language. Just describe what you need.</p>
    </div>

    <div class="doc-chat-container">
        <div class="doc-chat-main">
            <div class="doc-messages" id="docMessages">
                <div class="doc-welcome" id="docWelcome">
                    <div class="doc-welcome-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </div>
                    <h2>Document Assistant</h2>
                    <p>Tell me what document you need, and I'll help you generate it with the correct formatting and variables filled in.</p>
                </div>
            </div>

            <div class="doc-input-container">
                <div class="doc-input-wrapper">
                    <textarea id="docInput" placeholder="Describe the document you need..." rows="1"></textarea>
                    <button id="docSend" class="btn-send">
                        Go
                    </button>
                </div>
            </div>
        </div>

        <div class="doc-sidebar">
            <div class="doc-panel">
                <h3>Pleadings &amp; Appearances</h3>
                <div class="example-prompts">
                    <button class="example-prompt" data-prompt="I need an entry of appearance for Jefferson County">Entry of Appearance (State)</button>
                    <button class="example-prompt" data-prompt="Entry of appearance for Bridgeton Municipal Court">Entry of Appearance (Muni)</button>
                    <button class="example-prompt" data-prompt="Generate a waiver of arraignment for Jefferson County">Waiver of Arraignment</button>
                    <button class="example-prompt" data-prompt="I need a petition for review for Jefferson County DWI refusal">Petition for Review (PFR)</button>
                    <button class="example-prompt" data-prompt="Request for jury trial for Franklin County">Request for Jury Trial</button>
                    <button class="example-prompt" data-prompt="Entry for Jefferson County case">Entry (Generic)</button>
                    <button class="example-prompt" data-prompt="Plea of guilty for Jefferson County">Plea of Guilty</button>
                    <button class="example-prompt" data-prompt="Waiver of preliminary hearing for Franklin County">Waiver of Preliminary Hearing</button>
                    <button class="example-prompt" data-prompt="PH waiver for Jefferson County">PH Waiver</button>
                    <button class="example-prompt" data-prompt="Petition for trial de novo for Jefferson County DOR case">Petition for TDN</button>
                </div>
            </div>

            <div class="doc-panel">
                <h3>Motions</h3>
                <div class="example-prompts">
                    <button class="example-prompt" data-prompt="I need a motion for continuance for St. Louis County">Motion for Continuance</button>
                    <button class="example-prompt" data-prompt="I need a motion to dismiss for Jefferson County">Motion to Dismiss</button>
                    <button class="example-prompt" data-prompt="DOR motion to dismiss for Jefferson County">DOR Motion to Dismiss</button>
                    <button class="example-prompt" data-prompt="Motion for change of judge for Franklin County">Change of Judge</button>
                    <button class="example-prompt" data-prompt="Motion to recall warrant for Jeffco Municipal Court">Recall Warrant</button>
                    <button class="example-prompt" data-prompt="Motion for bond reduction for St. Louis County">Bond Reduction</button>
                    <button class="example-prompt" data-prompt="Motion to amend bond conditions for Jefferson County">Amend Bond Conditions</button>
                    <button class="example-prompt" data-prompt="Motion to certify for jury trial for Bridgeton Municipal">Certify for Jury Trial</button>
                    <button class="example-prompt" data-prompt="Motion to shorten time for Jefferson County">Shorten Time</button>
                    <button class="example-prompt" data-prompt="Motion to appear via WebEx for Jefferson County DOR">Appear via WebEx</button>
                    <button class="example-prompt" data-prompt="Motion to place on docket for Franklin County">Place on Docket</button>
                    <button class="example-prompt" data-prompt="Motion to compel discovery for Jefferson County">Compel Discovery</button>
                    <button class="example-prompt" data-prompt="Motion to terminate probation for St. Louis County">Terminate Probation</button>
                    <button class="example-prompt" data-prompt="Motion to dismiss for Jefferson County criminal case">Motion to Dismiss (County)</button>
                    <button class="example-prompt" data-prompt="Motion to withdraw guilty plea for Franklin County">Withdraw Guilty Plea</button>
                    <button class="example-prompt" data-prompt="Motion to withdraw as counsel for Jefferson County">Motion to Withdraw</button>
                </div>
            </div>

            <div class="doc-panel">
                <h3>Discovery</h3>
                <div class="example-prompts">
                    <button class="example-prompt" data-prompt="Request for discovery for Franklin County">Request for Discovery</button>
                    <button class="example-prompt" data-prompt="Request for supplemental discovery for Jefferson County">Supplemental Discovery</button>
                    <button class="example-prompt" data-prompt="Notice to take deposition for Jefferson County">Notice to Take Deposition</button>
                    <button class="example-prompt" data-prompt="Answer for request to produce for Jefferson County">Answer for Req. to Produce</button>
                    <button class="example-prompt" data-prompt="Request for transcripts for Jefferson County case">Request for Transcripts</button>
                </div>
            </div>

            <div class="doc-panel">
                <h3>Letters</h3>
                <div class="example-prompts">
                    <button class="example-prompt" data-prompt="I need a preservation letter for Arnold Police Department">Preservation Letter</button>
                    <button class="example-prompt" data-prompt="Preservation and supplemental discovery letter for MSHP">Preservation + Supplemental</button>
                    <button class="example-prompt" data-prompt="Potential prosecution letter for Cole County">Prosecution Letter</button>
                    <button class="example-prompt" data-prompt="After supplemental disclosure letter for Jefferson County prosecutor">After Supp. Disclosure</button>
                    <button class="example-prompt" data-prompt="Letter to client with discovery for Jefferson County case">Client Discovery Cover</button>
                    <button class="example-prompt" data-prompt="Disposition letter to client for O'Fallon Municipal case">Disposition Letter</button>
                    <button class="example-prompt" data-prompt="DL reinstatement letter to client">DL Reinstatement Letter</button>
                    <button class="example-prompt" data-prompt="Closing letter to client for Jefferson County case">Closing Letter</button>
                    <button class="example-prompt" data-prompt="Letter to DOR with petition for review">Ltr to DOR w/ PFR</button>
                    <button class="example-prompt" data-prompt="Letter to DOR with stay order">Ltr to DOR w/ Stay Order</button>
                    <button class="example-prompt" data-prompt="Letter to DOR with judgment">Ltr to DOR w/ Judgment</button>
                    <button class="example-prompt" data-prompt="Request for recommendation letter to prosecutor">Rec Letter to PA</button>
                    <button class="example-prompt" data-prompt="Requirements for recommendation letter to client">Requirements for Rec Letter</button>
                    <button class="example-prompt" data-prompt="Available court dates for trial for Jefferson County">Available Court Dates</button>
                </div>
            </div>

            <div class="doc-panel">
                <h3>Notices &amp; Orders</h3>
                <div class="example-prompts">
                    <button class="example-prompt" data-prompt="Notice of hearing for Jefferson County">Notice of Hearing</button>
                    <button class="example-prompt" data-prompt="Notice of hearing on motion to withdraw for Jefferson County">NOH - Motion to Withdraw</button>
                    <button class="example-prompt" data-prompt="Notice of change of address for Jefferson County">Change of Address</button>
                    <button class="example-prompt" data-prompt="I need a proposed stay order for Jefferson County DWI refusal">Proposed Stay Order</button>
                    <button class="example-prompt" data-prompt="Request for stay order for Jefferson County DWI case">Request for Stay Order</button>
                </div>
            </div>

            <div class="doc-panel">
                <h3>Bond &amp; Fees</h3>
                <div class="example-prompts">
                    <button class="example-prompt" data-prompt="Generate a bond assignment document">Bond Assignment</button>
                    <button class="example-prompt" data-prompt="I need a filing fee memo for a DOR case">Filing Fee Memo</button>
                </div>
            </div>

            <div class="doc-panel">
                <h3>DOR &amp; Administrative</h3>
                <div class="example-prompts">
                    <button class="example-prompt" data-prompt="Admin continuance request for DOR hearing">Admin Continuance</button>
                    <button class="example-prompt" data-prompt="Admin hearing request for DOR case">Admin Hearing Request</button>
                </div>
            </div>

            <div class="doc-panel">
                <h3>Recent Documents</h3>
                <div class="recent-docs" id="recentDocs">
                    <p style="color: #9ca3af; font-size: 0.85rem;">No recent documents yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const docMessages = document.getElementById('docMessages');
const docInput = document.getElementById('docInput');
const docSend = document.getElementById('docSend');
const docWelcome = document.getElementById('docWelcome');

let sessionId = null;

// Auto-resize textarea
docInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Handle send
docSend.addEventListener('click', sendMessage);
docInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Collapsible sidebar panels
document.querySelectorAll('.doc-panel h3').forEach((h3, index) => {
    h3.addEventListener('click', function() {
        const content = this.nextElementSibling;
        if (content) {
            this.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }
    });
    // Start all collapsed except first panel
    if (index > 0) {
        const content = h3.nextElementSibling;
        if (content) {
            h3.classList.add('collapsed');
            content.classList.add('collapsed');
        }
    }
});

// Example prompts
document.querySelectorAll('.example-prompt').forEach(btn => {
    btn.addEventListener('click', function() {
        docInput.value = this.dataset.prompt;
        docInput.focus();
    });
});

async function sendMessage() {
    const message = docInput.value.trim();
    if (!message) return;

    // Hide welcome
    if (docWelcome) {
        docWelcome.style.display = 'none';
    }

    // Add user message
    addMessage(message, 'user');
    docInput.value = '';
    docInput.style.height = 'auto';

    // Show typing indicator
    const typingId = showTyping();

    // Disable input
    docSend.disabled = true;

    try {
        const response = await fetch('/api/documents/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                session_id: sessionId
            })
        });

        const data = await response.json();

        // Remove typing indicator
        removeTyping(typingId);

        if (data.error) {
            addMessage('Error: ' + data.error, 'assistant');
        } else {
            // Store session ID
            if (data.session_id) {
                sessionId = data.session_id;
            }

            // Add assistant message
            addMessage(data.response, 'assistant', data.download_url);
        }
    } catch (error) {
        removeTyping(typingId);
        addMessage('Sorry, something went wrong. Please try again.', 'assistant');
    }

    docSend.disabled = false;
}

function addMessage(content, role, downloadUrl = null) {
    const div = document.createElement('div');
    div.className = `doc-message ${role}`;

    const avatar = document.createElement('div');
    avatar.className = 'doc-message-avatar';
    avatar.textContent = role === 'user' ? 'U' : 'AI';

    const contentDiv = document.createElement('div');
    contentDiv.className = 'doc-message-content';
    contentDiv.innerHTML = formatMessage(content);

    if (downloadUrl) {
        const downloadBtn = document.createElement('a');
        downloadBtn.href = downloadUrl;
        downloadBtn.className = 'doc-download-btn';
        downloadBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download Document
        `;
        contentDiv.appendChild(downloadBtn);
    }

    div.appendChild(avatar);
    div.appendChild(contentDiv);
    docMessages.appendChild(div);
    docMessages.scrollTop = docMessages.scrollHeight;
}

function formatMessage(text) {
    // Basic markdown-like formatting
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
}

function showTyping() {
    const id = 'typing-' + Date.now();
    const div = document.createElement('div');
    div.id = id;
    div.className = 'doc-message assistant';
    div.innerHTML = `
        <div class="doc-message-avatar">AI</div>
        <div class="doc-message-content">
            <div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    docMessages.appendChild(div);
    docMessages.scrollTop = docMessages.scrollHeight;
    return id;
}

function removeTyping(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
}
</script>
{% endblock %}
